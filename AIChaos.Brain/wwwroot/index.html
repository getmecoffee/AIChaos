<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMod AI Chaos Controller</title>
    <style>
        :root {
            --primary: #00ff41;
            --primary-dark: #00cc33;
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text: #00ff41;
            --text-dim: #888;
            --border: #333;
            --error: #ff3333;
            --success: #00ff41;
            --warning: #ff9900;
            --info: #00ccff;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
        }
        
        h1, h2, h3 {
            text-shadow: 0 0 10px var(--primary);
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            color: var(--primary);
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background: var(--primary);
            color: #000;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-connected {
            background: var(--success);
            color: #000;
        }
        
        .status-disconnected {
            background: var(--error);
            color: #fff;
        }
        
        .status-pending {
            background: var(--warning);
            color: #000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text);
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            background: #000;
            border: 1px solid var(--border);
            color: #fff;
            font-family: inherit;
            font-size: 14px;
            border-radius: 5px;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-group small {
            color: var(--text-dim);
            font-size: 12px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        button, .btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        button:hover, .btn:hover {
            background: var(--primary-dark);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #555;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background: #777;
        }
        
        .btn-danger {
            background: var(--error);
            color: #fff;
        }
        
        .btn-info {
            background: var(--info);
            color: #000;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #000;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        textarea#promptInput {
            height: 100px;
            resize: vertical;
        }
        
        #status {
            background: #000;
            border: 1px solid var(--border);
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
            border-radius: 5px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #222;
        }
        
        .log-entry.error { color: var(--error); }
        .log-entry.success { color: var(--success); }
        
        .my-history {
            margin-top: 20px;
        }
        
        .history-item {
            background: #0a0a0a;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .history-prompt {
            flex: 1;
            font-size: 13px;
        }
        
        .history-time {
            color: var(--text-dim);
            font-size: 11px;
        }
        
        .history-source {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #333;
        }
        
        .history-source.web { color: var(--primary); }
        .history-source.twitch { color: #9146ff; }
        .history-source.youtube { color: #ff0000; }
        
        .history-actions {
            display: flex;
            gap: 5px;
        }
        
        .history-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .empty-state {
            color: var(--text-dim);
            font-style: italic;
            text-align: center;
            padding: 30px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .setup-step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: #0a0a0a;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h4 {
            margin: 0 0 5px 0;
        }
        
        .step-content p {
            margin: 0;
            color: var(--text-dim);
            font-size: 13px;
        }
        
        .oauth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .twitch-btn {
            background: #9146ff;
        }
        
        .twitch-btn:hover {
            background: #7c3aed;
        }
        
        .youtube-btn {
            background: #ff0000;
        }
        
        .youtube-btn:hover {
            background: #cc0000;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .alert-error {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        .alert-info {
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid var(--info);
            color: var(--info);
        }
        
        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible::after {
            content: ' ‚ñº';
            font-size: 10px;
        }
        
        .collapsible.collapsed::after {
            content: ' ‚ñ∂';
        }
        
        .code-block {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ AI CHAOS CONTROL</h1>
            <p>Control GMod through AI-powered chat commands</p>
        </div>
        
        <div class="nav">
            <a href="#" class="nav-link active" data-page="control">‚ö° Control Panel</a>
            <a href="#" class="nav-link" data-page="setup">üîß Setup</a>
            <a href="#" class="nav-link" data-page="history">üìú History</a>
        </div>
        
        <!-- CONTROL PANEL PAGE -->
        <div id="page-control" class="page">
            <div class="card">
                <h2>Send Chaos Command</h2>
                <div class="form-group">
                    <textarea id="promptInput" placeholder="Ex: Make everyone tiny, Spawn 10 headcrabs, Turn the screen upside down..."></textarea>
                </div>
                <button id="sendBtn" onclick="sendPrompt()">‚ö° SEND CHAOS</button>
                
                <div id="status" style="margin-top: 15px;"></div>
            </div>
            
            <div class="card my-history">
                <h2>üìã Recent Commands</h2>
                <div id="myHistory">
                    <div class="empty-state">Commands will appear here...</div>
                </div>
            </div>
        </div>
        
        <!-- SETUP PAGE -->
        <div id="page-setup" class="page hidden">
            <div id="setupAlerts"></div>
            
            <!-- OpenRouter Setup -->
            <div class="card">
                <h2>
                    ü§ñ OpenRouter API
                    <span id="openrouterStatus" class="status-badge status-disconnected">Not Configured</span>
                </h2>
                <p style="color: var(--text-dim); margin-bottom: 15px;">
                    OpenRouter provides access to AI models for generating Lua code.
                </p>
                
                <div class="setup-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Get an API Key</h4>
                        <p>Visit <a href="https://openrouter.ai/keys" target="_blank" style="color: var(--info);">openrouter.ai/keys</a> to create an account and generate an API key.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="openrouterApiKey" placeholder="sk-or-v1-...">
                </div>
                
                <div class="form-group">
                    <label>Model (optional)</label>
                    <select id="openrouterModel">
                        <option value="anthropic/claude-sonnet-4.5">Claude Sonnet 4.5 (Recommended)</option>
                        <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                        <option value="openai/gpt-4o">GPT-4o</option>
                        <option value="openai/gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                    </select>
                </div>
                
                <button onclick="saveOpenRouter()">üíæ Save OpenRouter Settings</button>
            </div>
            
            <!-- Twitch Setup -->
            <div class="card">
                <h2>
                    <span style="color: #9146ff;">üì∫</span> Twitch Integration
                    <span id="twitchStatus" class="status-badge status-disconnected">Not Connected</span>
                </h2>
                <p style="color: var(--text-dim); margin-bottom: 15px;">
                    Connect to Twitch to receive chaos commands from your chat.
                </p>
                
                <div class="setup-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Create a Twitch Application</h4>
                        <p>Go to <a href="https://dev.twitch.tv/console/apps" target="_blank" style="color: var(--info);">dev.twitch.tv/console</a> and create a new application. Set the OAuth Redirect URL to: <code id="twitchRedirectUrl">Loading...</code></p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Client ID</label>
                        <input type="text" id="twitchClientId" placeholder="Your Twitch Client ID">
                    </div>
                    <div class="form-group">
                        <label>Client Secret</label>
                        <input type="password" id="twitchClientSecret" placeholder="Your Twitch Client Secret">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Channel Name</label>
                        <input type="text" id="twitchChannel" placeholder="Your channel name">
                    </div>
                    <div class="form-group">
                        <label>Chat Command</label>
                        <input type="text" id="twitchCommand" value="!chaos" placeholder="!chaos">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="twitchRequireBits">
                        <label for="twitchRequireBits" style="margin: 0;">Require Bits</label>
                    </div>
                    <div class="form-group">
                        <label>Minimum Bits</label>
                        <input type="number" id="twitchMinBits" value="100" min="1">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button onclick="saveTwitchCredentials()" class="btn-secondary">üíæ Save Credentials</button>
                    <button onclick="authorizeTwitch()" class="twitch-btn">üîó Login with Twitch</button>
                    <button onclick="connectTwitch()" id="twitchConnectBtn" class="btn-info">‚ñ∂Ô∏è Start Listening</button>
                    <button onclick="disconnectTwitch()" id="twitchDisconnectBtn" class="btn-danger hidden">‚èπÔ∏è Stop</button>
                </div>
            </div>
            
            <!-- YouTube Setup -->
            <div class="card">
                <h2>
                    <span style="color: #ff0000;">üì∫</span> YouTube Integration
                    <span id="youtubeStatus" class="status-badge status-disconnected">Not Connected</span>
                </h2>
                <p style="color: var(--text-dim); margin-bottom: 15px;">
                    Connect to YouTube to receive Super Chat commands from your live stream.
                </p>
                
                <div class="setup-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Create a Google Cloud Project</h4>
                        <p>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: var(--info);">Google Cloud Console</a>, create a project, enable the YouTube Data API v3, and create OAuth credentials. Set the redirect URI to: <code id="youtubeRedirectUrl">Loading...</code></p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Client ID</label>
                        <input type="text" id="youtubeClientId" placeholder="Your Google Client ID">
                    </div>
                    <div class="form-group">
                        <label>Client Secret</label>
                        <input type="password" id="youtubeClientSecret" placeholder="Your Google Client Secret">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Live Stream Video ID</label>
                        <input type="text" id="youtubeVideoId" placeholder="e.g., dQw4w9WgXcQ">
                        <small>The video ID from your live stream URL</small>
                    </div>
                    <div class="form-group">
                        <label>Minimum Super Chat ($)</label>
                        <input type="number" id="youtubeMinAmount" value="1.00" min="0" step="0.01">
                    </div>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="youtubeAllowChat">
                    <label for="youtubeAllowChat" style="margin: 0;">Also allow regular chat commands (not just Super Chats)</label>
                </div>
                
                <div class="btn-group">
                    <button onclick="saveYouTubeCredentials()" class="btn-secondary">üíæ Save Credentials</button>
                    <button onclick="authorizeYouTube()" class="youtube-btn">üîó Login with YouTube</button>
                    <button onclick="startYouTube()" id="youtubeStartBtn" class="btn-info">‚ñ∂Ô∏è Start Listening</button>
                    <button onclick="stopYouTube()" id="youtubeStopBtn" class="btn-danger hidden">‚èπÔ∏è Stop</button>
                </div>
            </div>
        </div>
        
        <!-- HISTORY PAGE -->
        <div id="page-history" class="page hidden">
            <div class="card">
                <h2>üìú Command History</h2>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="includeHistoryInAi" onchange="updatePreferences()">
                    <label for="includeHistoryInAi" style="margin: 0;">Feed history to AI context</label>
                </div>
                
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button onclick="loadHistory()" class="btn-secondary">üîÑ Refresh</button>
                    <button onclick="clearHistory()" class="btn-danger">üóëÔ∏è Clear All</button>
                </div>
                
                <div id="historyList">
                    <div class="empty-state">Loading history...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentPage = 'control';
        let setupStatus = null;
        let commandHistory = [];
        
        // ==========================================
        // NAVIGATION
        // ==========================================
        
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                showPage(page);
            });
        });
        
        function showPage(page) {
            currentPage = page;
            
            // Update nav
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            // Show page
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            // Load data if needed
            if (page === 'setup') loadSetupStatus();
            if (page === 'history') loadHistory();
        }
        
        // Check URL hash for page navigation
        function checkHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#/setup')) {
                showPage('setup');
                
                // Check for success/error messages
                const params = new URLSearchParams(hash.split('?')[1] || '');
                const success = params.get('success');
                const error = params.get('error');
                
                if (success) {
                    showSetupAlert(`${success.charAt(0).toUpperCase() + success.slice(1)} connected successfully!`, 'success');
                }
                if (error) {
                    showSetupAlert(`Authentication failed: ${error}`, 'error');
                }
            } else if (hash.startsWith('#/history')) {
                showPage('history');
            }
        }
        
        window.addEventListener('hashchange', checkHash);
        
        // ==========================================
        // CONTROL PANEL
        // ==========================================
        
        const statusDiv = document.getElementById('status');
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        
        function log(msg, type = 'normal') {
            const el = document.createElement('div');
            el.className = 'log-entry ' + type;
            el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            statusDiv.prepend(el);
        }
        
        async function sendPrompt() {
            const text = promptInput.value.trim();
            if (!text) return;
            
            promptInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = "‚è≥ GENERATING...";
            
            try {
                const response = await fetch('/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: text })
                });
                
                const data = await response.json();
                
                if (data.status === 'queued') {
                    log(`‚úì ${text}`, 'success');
                    updateRecentCommands();
                } else if (data.status === 'ignored') {
                    log(`‚úó BLOCKED: ${data.message}`, 'error');
                } else {
                    log(`‚úó ERROR: ${JSON.stringify(data)}`, 'error');
                }
            } catch (err) {
                log(`‚úó NETWORK ERROR: ${err.message}`, 'error');
            }
            
            promptInput.value = '';
            promptInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = "‚ö° SEND CHAOS";
            promptInput.focus();
        }
        
        promptInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                sendPrompt();
            }
        });
        
        async function updateRecentCommands() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                const container = document.getElementById('myHistory');
                const recent = data.history.slice(-10).reverse();
                
                if (recent.length === 0) {
                    container.innerHTML = '<div class="empty-state">Commands will appear here...</div>';
                    return;
                }
                
                container.innerHTML = recent.map(cmd => `
                    <div class="history-item">
                        <div style="flex: 1;">
                            <div class="history-time">${new Date(cmd.timestamp).toLocaleTimeString()}</div>
                            <div class="history-prompt">${escapeHtml(cmd.userPrompt)}</div>
                        </div>
                        <span class="history-source ${cmd.source}">${cmd.source}</span>
                        <div class="history-actions">
                            <button onclick="repeatCommand(${cmd.id})" class="btn-info">üîÅ</button>
                            <button onclick="undoCommand(${cmd.id})" class="btn-warning">‚Ü©</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load recent commands:', err);
            }
        }
        
        async function repeatCommand(id) {
            try {
                const response = await fetch('/api/repeat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commandId: id })
                });
                const data = await response.json();
                log(data.status === 'success' ? '‚úì Command repeated!' : `‚úó ${data.message}`, data.status === 'success' ? 'success' : 'error');
            } catch (err) {
                log('‚úó Network error', 'error');
            }
        }
        
        async function undoCommand(id) {
            try {
                const response = await fetch('/api/undo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commandId: id })
                });
                const data = await response.json();
                log(data.status === 'success' ? '‚úì Command undone!' : `‚úó ${data.message}`, data.status === 'success' ? 'success' : 'error');
            } catch (err) {
                log('‚úó Network error', 'error');
            }
        }
        
        // ==========================================
        // SETUP
        // ==========================================
        
        async function loadSetupStatus() {
            try {
                const response = await fetch('/api/setup/status');
                setupStatus = await response.json();
                updateSetupUI();
            } catch (err) {
                console.error('Failed to load setup status:', err);
            }
            
            // Update redirect URLs
            const baseUrl = window.location.origin;
            document.getElementById('twitchRedirectUrl').textContent = `${baseUrl}/api/setup/twitch/callback`;
            document.getElementById('youtubeRedirectUrl').textContent = `${baseUrl}/api/setup/youtube/callback`;
        }
        
        function updateSetupUI() {
            if (!setupStatus) return;
            
            // OpenRouter
            const orStatus = document.getElementById('openrouterStatus');
            if (setupStatus.openRouterConfigured) {
                orStatus.textContent = 'Configured';
                orStatus.className = 'status-badge status-connected';
            } else {
                orStatus.textContent = 'Not Configured';
                orStatus.className = 'status-badge status-disconnected';
            }
            
            // Twitch
            const twitchStatus = document.getElementById('twitchStatus');
            const twitchConnectBtn = document.getElementById('twitchConnectBtn');
            const twitchDisconnectBtn = document.getElementById('twitchDisconnectBtn');
            
            if (setupStatus.twitch.isListening) {
                twitchStatus.textContent = `Listening: ${setupStatus.twitch.channel}`;
                twitchStatus.className = 'status-badge status-connected';
                twitchConnectBtn.classList.add('hidden');
                twitchDisconnectBtn.classList.remove('hidden');
            } else if (setupStatus.twitch.isAuthenticated) {
                twitchStatus.textContent = 'Authenticated';
                twitchStatus.className = 'status-badge status-pending';
                twitchConnectBtn.classList.remove('hidden');
                twitchDisconnectBtn.classList.add('hidden');
            } else {
                twitchStatus.textContent = 'Not Connected';
                twitchStatus.className = 'status-badge status-disconnected';
                twitchConnectBtn.classList.remove('hidden');
                twitchDisconnectBtn.classList.add('hidden');
            }
            
            // YouTube
            const youtubeStatus = document.getElementById('youtubeStatus');
            const youtubeStartBtn = document.getElementById('youtubeStartBtn');
            const youtubeStopBtn = document.getElementById('youtubeStopBtn');
            
            if (setupStatus.youTube.isListening) {
                youtubeStatus.textContent = `Listening: ${setupStatus.youTube.videoId}`;
                youtubeStatus.className = 'status-badge status-connected';
                youtubeStartBtn.classList.add('hidden');
                youtubeStopBtn.classList.remove('hidden');
            } else if (setupStatus.youTube.isAuthenticated) {
                youtubeStatus.textContent = 'Authenticated';
                youtubeStatus.className = 'status-badge status-pending';
                youtubeStartBtn.classList.remove('hidden');
                youtubeStopBtn.classList.add('hidden');
            } else {
                youtubeStatus.textContent = 'Not Connected';
                youtubeStatus.className = 'status-badge status-disconnected';
                youtubeStartBtn.classList.remove('hidden');
                youtubeStopBtn.classList.add('hidden');
            }
        }
        
        function showSetupAlert(message, type) {
            const container = document.getElementById('setupAlerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.prepend(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }
        
        async function saveOpenRouter() {
            const apiKey = document.getElementById('openrouterApiKey').value;
            const model = document.getElementById('openrouterModel').value;
            
            try {
                const response = await fetch('/api/setup/openrouter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, model })
                });
                
                if (response.ok) {
                    showSetupAlert('OpenRouter settings saved!', 'success');
                    loadSetupStatus();
                } else {
                    showSetupAlert('Failed to save settings', 'error');
                }
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function saveTwitchCredentials() {
            const data = {
                clientId: document.getElementById('twitchClientId').value,
                clientSecret: document.getElementById('twitchClientSecret').value,
                channel: document.getElementById('twitchChannel').value,
                chatCommand: document.getElementById('twitchCommand').value,
                requireBits: document.getElementById('twitchRequireBits').checked,
                minBitsAmount: parseInt(document.getElementById('twitchMinBits').value) || 100
            };
            
            try {
                const response = await fetch('/api/setup/twitch/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showSetupAlert('Twitch credentials saved!', 'success');
                } else {
                    showSetupAlert('Failed to save Twitch credentials', 'error');
                }
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function authorizeTwitch() {
            try {
                const response = await fetch('/api/setup/twitch/auth-url');
                const data = await response.json();
                
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else {
                    showSetupAlert(data.message || 'Failed to get auth URL', 'error');
                }
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function connectTwitch() {
            try {
                const response = await fetch('/api/setup/twitch/connect', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showSetupAlert(`Connected to Twitch: ${data.channel}`, 'success');
                    loadSetupStatus();
                } else {
                    showSetupAlert(data.message || 'Failed to connect', 'error');
                }
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function disconnectTwitch() {
            try {
                await fetch('/api/setup/twitch/disconnect', { method: 'POST' });
                showSetupAlert('Disconnected from Twitch', 'info');
                loadSetupStatus();
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function saveYouTubeCredentials() {
            const data = {
                clientId: document.getElementById('youtubeClientId').value,
                clientSecret: document.getElementById('youtubeClientSecret').value,
                videoId: document.getElementById('youtubeVideoId').value,
                minSuperChatAmount: parseFloat(document.getElementById('youtubeMinAmount').value) || 1.00,
                allowRegularChat: document.getElementById('youtubeAllowChat').checked
            };
            
            try {
                const response = await fetch('/api/setup/youtube/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showSetupAlert('YouTube credentials saved!', 'success');
                } else {
                    showSetupAlert('Failed to save YouTube credentials', 'error');
                }
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function authorizeYouTube() {
            try {
                const response = await fetch('/api/setup/youtube/auth-url');
                const data = await response.json();
                
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else {
                    showSetupAlert(data.message || 'Failed to get auth URL', 'error');
                }
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function startYouTube() {
            const videoId = document.getElementById('youtubeVideoId').value;
            
            try {
                const response = await fetch('/api/setup/youtube/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showSetupAlert(`Started listening to YouTube: ${data.videoId}`, 'success');
                    loadSetupStatus();
                } else {
                    showSetupAlert(data.message || 'Failed to start', 'error');
                }
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        async function stopYouTube() {
            try {
                await fetch('/api/setup/youtube/stop', { method: 'POST' });
                showSetupAlert('Stopped YouTube listener', 'info');
                loadSetupStatus();
            } catch (err) {
                showSetupAlert('Network error', 'error');
            }
        }
        
        // ==========================================
        // HISTORY PAGE
        // ==========================================
        
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                commandHistory = data.history;
                document.getElementById('includeHistoryInAi').checked = data.preferences.includeHistoryInAi;
                
                renderHistory();
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }
        
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (commandHistory.length === 0) {
                container.innerHTML = '<div class="empty-state">No commands in history yet.</div>';
                return;
            }
            
            container.innerHTML = [...commandHistory].reverse().map(cmd => `
                <div class="history-item" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="history-time">#${cmd.id} - ${new Date(cmd.timestamp).toLocaleString()}</div>
                            <div class="history-prompt" style="margin-top: 5px;">${escapeHtml(cmd.userPrompt)}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="history-source ${cmd.source}">${cmd.source}</span>
                            <div class="history-actions">
                                <button onclick="repeatCommand(${cmd.id})" class="btn-info">üîÅ Repeat</button>
                                <button onclick="undoCommand(${cmd.id})" class="btn-warning">‚Ü© Undo</button>
                                <button onclick="forceUndo(${cmd.id})" class="btn-danger">‚ö† Force</button>
                                <button onclick="toggleCode(${cmd.id})" class="btn-secondary">üëÅ Code</button>
                            </div>
                        </div>
                    </div>
                    <div id="code-${cmd.id}" class="hidden" style="margin-top: 10px;">
                        <div class="code-block">
                            <strong>Execution Code:</strong>
${escapeHtml(cmd.executionCode)}

<strong>Undo Code:</strong>
${escapeHtml(cmd.undoCode)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleCode(id) {
            const codeDiv = document.getElementById(`code-${id}`);
            codeDiv.classList.toggle('hidden');
        }
        
        async function forceUndo(id) {
            try {
                const response = await fetch('/api/force_undo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commandId: id })
                });
                const data = await response.json();
                alert(data.status === 'success' ? 'Force undo queued!' : data.message);
            } catch (err) {
                alert('Network error');
            }
        }
        
        async function updatePreferences() {
            const includeHistory = document.getElementById('includeHistoryInAi').checked;
            
            try {
                await fetch('/api/preferences', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ includeHistoryInAi: includeHistory })
                });
            } catch (err) {
                console.error('Failed to update preferences:', err);
            }
        }
        
        async function clearHistory() {
            if (!confirm('Are you sure you want to clear all command history?')) return;
            
            try {
                await fetch('/api/clear_history', { method: 'POST' });
                loadHistory();
            } catch (err) {
                alert('Failed to clear history');
            }
        }
        
        // ==========================================
        // UTILITIES
        // ==========================================
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        checkHash();
        updateRecentCommands();
        
        // Auto-refresh recent commands
        setInterval(updateRecentCommands, 5000);
    </script>
</body>
</html>
